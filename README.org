#+TITLE: CPub

A semantic ActivityPub server.

* About

CPub is a general [[https://www.w3.org/TR/activitypub/][ActivityPub]] server built upon Semantic Web ideas. Most notably it also implements a [[https://www.w3.org/TR/ldp/][Linked Data Platform (LDP)]] and uses [[https://www.w3.org/TR/turtle/][RDF Turtle]] as serialization for data.

The project goals are:

- Develop a general ActivityPub server that can be used to create any kind of structured content.
- Experiment with using Linked Data (RDF) as data model for everything.

CPub is developed as part of the [[https://miaengiadina.github.io/openengiadina/][openEngiadina]] platform for open local knowledge. Development is supported by [[https://www.miaengiadina.ch/][miaEngiadina]].

* Quick start

To start the CPub server:

  * Install dependencies with `mix deps.get`
  * Create and migrate your database with `mix ecto.setup`
  * Start Phoenix endpoint with `mix phx.server`

Now you can visit [`localhost:4000`](http://localhost:4000) from your browser.

* Example
** Create a User

Users can be created from the Elixir shell.

For example we create the user "alice" with password "123":

#+BEGIN_SRC elixir
CPub.Users.create_user(username: "alice", password: "123")
#+END_SRC

#+RESULTS:
#+BEGIN_SRC elixir
{:ok,
 %{
   :actor => %CPub.ActivityPub.Actor{
     __meta__: #Ecto.Schema.Metadata<:loaded, "ldp_rs">,
     authorizations: #Ecto.Association.NotLoaded<association :authorizations is not loaded>,
     data: #RDF.Description{subject: ~I<http://localhost:4000/users/alice>
          ~I<http://www.w3.org/1999/02/22-rdf-syntax-ns#type>
              ~I<http://www.w3.org/ns/activitystreams#Person>
          ~I<http://www.w3.org/ns/activitystreams#outbox>
              ~I<http://localhost:4000/users/alice/outbox>
          ~I<http://www.w3.org/ns/ldp#inbox>
              ~I<http://localhost:4000/users/alice/inbox>},
     id: ~I<http://localhost:4000/users/alice>,
     inserted_at: ~N[2020-01-09 14:54:07],
     updated_at: ~N[2020-01-09 14:54:07]
   },
   :inbox => %CPub.LDP.BasicContainer{
     __meta__: #Ecto.Schema.Metadata<:loaded, "ldp_rs">,
     authorizations: #Ecto.Association.NotLoaded<association :authorizations is not loaded>,
     data: #RDF.Description{subject: ~I<http://localhost:4000/users/alice/inbox>
          ~I<http://www.w3.org/1999/02/22-rdf-syntax-ns#type>
              ~I<http://www.w3.org/ns/ldp#BasicContainer>},
     id: ~I<http://localhost:4000/users/alice/inbox>,
     inserted_at: ~N[2020-01-09 14:54:07],
     updated_at: ~N[2020-01-09 14:54:07]
   },
   :outbox => %CPub.LDP.BasicContainer{
     __meta__: #Ecto.Schema.Metadata<:loaded, "ldp_rs">,
     authorizations: #Ecto.Association.NotLoaded<association :authorizations is not loaded>,
     data: #RDF.Description{subject: ~I<http://localhost:4000/users/alice/outbox>
          ~I<http://www.w3.org/1999/02/22-rdf-syntax-ns#type>
              ~I<http://www.w3.org/ns/ldp#BasicContainer>},
     id: ~I<http://localhost:4000/users/alice/outbox>,
     inserted_at: ~N[2020-01-09 14:54:07],
     updated_at: ~N[2020-01-09 14:54:07]
   },
   :user => %CPub.Users.User{
     __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
     actor: #Ecto.Association.NotLoaded<association :actor is not loaded>,
     actor_id: ~I<http://localhost:4000/users/alice>,
     authorizations: #Ecto.Association.NotLoaded<association :authorizations is not loaded>,
     id: ~I<http://localhost:4000/users/alice>,
     inserted_at: ~N[2020-01-09 14:54:07],
     password: "$pbkdf2-sha512$160000$jLYBk3vk4wHk2XdGIKUrIQ$Q3P/yKxLGP9e3ZZFByj9rGe1LvcYPUQxWhwCEm0gOo5UaDC7QuEHfJULUgW4rAREPfPheurnOkbs0DqqdXKnPQ",
     updated_at: ~N[2020-01-09 14:54:07],
     username: "alice"
   },
   "authorizations/read" => %CPub.WebACL.Authorization{
     __meta__: #Ecto.Schema.Metadata<:loaded, "authorizations">,
     id: ~I<http://localhost:4000/users/alice/authorizations/read>,
     inserted_at: ~N[2020-01-09 14:54:07],
     mode_append: false,
     mode_control: false,
     mode_read: true,
     mode_write: false,
     resources: #Ecto.Association.NotLoaded<association :resources is not loaded>,
     updated_at: ~N[2020-01-09 14:54:07],
     user: #Ecto.Association.NotLoaded<association :user is not loaded>,
     user_id: ~I<http://localhost:4000/users/alice>
   },
   "authorizations/write" => %CPub.WebACL.Authorization{
     __meta__: #Ecto.Schema.Metadata<:loaded, "authorizations">,
     id: ~I<http://localhost:4000/users/alice/authorizations/write>,
     inserted_at: ~N[2020-01-09 14:54:07],
     mode_append: false,
     mode_control: false,
     mode_read: false,
     mode_write: true,
     resources: #Ecto.Association.NotLoaded<association :resources is not loaded>,
     updated_at: ~N[2020-01-09 14:54:07],
     user: #Ecto.Association.NotLoaded<association :user is not loaded>,
     user_id: ~I<http://localhost:4000/users/alice>
   },
   "grant authorizations/read to actor" => %CPub.WebACL.AuthorizationResource{
     __meta__: #Ecto.Schema.Metadata<:loaded, "authorizations_resources">,
     authorization: #Ecto.Association.NotLoaded<association :authorization is not loaded>,
     authorization_id: ~I<http://localhost:4000/users/alice/authorizations/read>,
     id: 3,
     resource: #Ecto.Association.NotLoaded<association :resource is not loaded>,
     resource_id: ~I<http://localhost:4000/users/alice>
   },
   "grant authorizations/read to inbox" => %CPub.WebACL.AuthorizationResource{
     __meta__: #Ecto.Schema.Metadata<:loaded, "authorizations_resources">,
     authorization: #Ecto.Association.NotLoaded<association :authorization is not loaded>,
     authorization_id: ~I<http://localhost:4000/users/alice/authorizations/read>,
     id: 1,
     resource: #Ecto.Association.NotLoaded<association :resource is not loaded>,
     resource_id: ~I<http://localhost:4000/users/alice/inbox>
   },
   "grant authorizations/read to outbox" => %CPub.WebACL.AuthorizationResource{
     __meta__: #Ecto.Schema.Metadata<:loaded, "authorizations_resources">,
     authorization: #Ecto.Association.NotLoaded<association :authorization is not loaded>,
     authorization_id: ~I<http://localhost:4000/users/alice/authorizations/read>,
     id: 2,
     resource: #Ecto.Association.NotLoaded<association :resource is not loaded>,
     resource_id: ~I<http://localhost:4000/users/alice/outbox>
   },
   "grant authorizations/write to actor" => %CPub.WebACL.AuthorizationResource{
     __meta__: #Ecto.Schema.Metadata<:loaded, "authorizations_resources">,
     authorization: #Ecto.Association.NotLoaded<association :authorization is not loaded>,
     authorization_id: ~I<http://localhost:4000/users/alice/authorizations/write>,
     id: 4,
     resource: #Ecto.Association.NotLoaded<association :resource is not loaded>,
     resource_id: ~I<http://localhost:4000/users/alice>
   }
 }}
#+END_SRC elixir

This creates the user, an actor profile, inbox and outbox for the user and inserts it into the database in a transaction.

The id of the newly created user is http://localhost:4000/users/alice:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix as: <http://www.w3.org/ns/activitystreams#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .

<http://localhost:4000/users/alice>
    a as:Person ;
    as:outbox <http://localhost:4000/users/alice/outbox> ;
    ldp:inbox <http://localhost:4000/users/alice/inbox> .

// GET http://localhost:4000/users/alice
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 437
// content-type: text/turtle; charset=utf-8
// date: Tue, 07 Jan 2020 12:35:03 GMT
// server: Cowboy
// x-request-id: Feea5TvFCYSxPW8AAAPh
// Request duration: 0.009779s
#+END_SRC

An inbox and outbox has been created for the actor. Both can be accessed:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice/inbox
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix as: <http://www.w3.org/ns/activitystreams#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .

<http://localhost:4000/users/alice/inbox>
    a ldp:BasicContainer .

// GET http://localhost:4000/users/alice/inbox
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 335
// content-type: text/turtle; charset=utf-8
// date: Tue, 07 Jan 2020 12:36:25 GMT
// server: Cowboy
// x-request-id: Feea-DktSCrXJwoAAAQh
// Request duration: 0.009204s
#+END_SRC

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice/inbox
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix as: <http://www.w3.org/ns/activitystreams#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .

<http://localhost:4000/users/alice/inbox>
    a ldp:BasicContainer .

// GET http://localhost:4000/users/alice/inbox
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 335
// content-type: text/turtle; charset=utf-8
// date: Tue, 07 Jan 2020 12:36:35 GMT
// server: Cowboy
// x-request-id: Feea-ruj1M4uHIkAAARh
// Request duration: 0.013530s
#+END_SRC

Note that currently the inbox and outbox are Linked Data Platform basic containers and not ActivityStreams Collections. In the future they will be both.

** Posting an Activity

#+BEGIN_SRC restclient :exports both
POST http://localhost:4000/users/alice/outbox
Accept: text/turtle
Content-type: text/turtle

@prefix as: <http://www.w3.org/ns/activitystreams#> .

<>
    a as:Create ;
    as:actor <http://localhost:4000/users/alice> ;
    as:object _:object .

_:object
    a as:Note ;
    as:content "Good day!"@en ;
    as:content "Guten Tag!"@de ;
    as:content "Grüezi"@gsw ;
    as:content "Bun di!"@roh .
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
// POST http://localhost:4000/users/alice/outbox
// HTTP/1.1 201 Created
// Location: http://localhost:4000/objects/be150bdb-d95d-4bf3-9203-ff4e82577b38
// cache-control: max-age=0, private, must-revalidate
// content-length: 0
// date: Tue, 07 Jan 2020 12:37:26 GMT
// server: Cowboy
// x-request-id: FeebBmkWuuPgNwQAAASB
// Request duration: 0.029260s
#+END_SRC

The activity has been created and can be accessed:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/objects/be150bdb-d95d-4bf3-9203-ff4e82577b38
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix as: <http://www.w3.org/ns/activitystreams#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .

<http://localhost:4000/objects/be150bdb-d95d-4bf3-9203-ff4e82577b38>
    a as:Create ;
    as:actor <http://localhost:4000/users/alice> ;
    as:object <http://localhost:4000/objects/83a3a097-42d7-4b3b-91b5-a8d7ba97971c> .

// GET http://localhost:4000/objects/be150bdb-d95d-4bf3-9203-ff4e82577b38
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 489
// content-type: text/turtle; charset=utf-8
// date: Tue, 07 Jan 2020 12:37:50 GMT
// server: Cowboy
// x-request-id: FeebDA4Ac24Cd0MAAATB
// Request duration: 0.008027s
#+END_SRC

Note that the object has received an id for itself and can be accessed directly:

#+BEGIN_SRC restclient :exports both
GET <http://localhost:4000/objects/83a3a097-42d7-4b3b-91b5-a8d7ba97971c> .
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix as: <http://www.w3.org/ns/activitystreams#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .

<http://localhost:4000/objects/d695695c-c9a5-4426-a47b-df8544cf8e68>
    a as:Note ;
    as:content "Guten Tag!"@de, "Good day!"@en, "Grüezi"@gsw, "Bun di!"@roh .

// GET http://localhost:4000/objects/d695695c-c9a5-4426-a47b-df8544cf8e68
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 430
// content-type: text/turtle; charset=utf-8
// date: Thu, 19 Dec 2019 11:40:03 GMT
// server: Cowboy
// x-request-id: FeHC3fvJbMtGHC4AAAFC
// Request duration: 0.013231s
#+END_SRC

The activity has also been placed in the actor's outbox:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice/outbox
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix as: <http://www.w3.org/ns/activitystreams#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .

<http://localhost:4000/users/alice/outbox>
    a ldp:BasicContainer ;
    ldp:contains <http://localhost:4000/objects/be150bdb-d95d-4bf3-9203-ff4e82577b38> .

// GET http://localhost:4000/users/alice/outbox
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 424
// content-type: text/turtle; charset=utf-8
// date: Tue, 07 Jan 2020 12:38:28 GMT
// server: Cowboy
// x-request-id: FeebFPHWQ0oEDbQAAATh
// Request duration: 0.008352s
#+END_SRC
