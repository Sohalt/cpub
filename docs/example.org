#+TITLE: Example

* Create a User

Users can be created from the Elixir shell.

For example we create the user "alice" with password "123":

#+BEGIN_SRC elixir
CPub.User.create(%{username: "alice", password: "123"})
#+END_SRC

This creates the user, an actor profile, inbox and outbox for the user and inserts it into the database in a transaction.

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@base <http://localhost:4000/users/alice/> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/users/alice>
    a foaf:PersonalProfileDocument, as:Person ;
    ldp:inbox <inbox> ;
    foaf:primaryTopic <me> ;
    as:outbox <outbox> ;
    as:preferredUsername "alice" .

<me>
    a foaf:Person ;
    foaf:name "alice" ;
    foaf:nick "alice" .

// GET http://localhost:4000/users/alice
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 628
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 07:31:08 GMT
// server: Cowboy
// x-request-id: FhBdfxTVbfZ-fa8AAALB
// Request duration: 0.251348s
#+END_SRC

An inbox and outbox has been created for the actor. Both can be accessed, but we
need to be authenticated first.

We can authenticate as Alice with HTTP Basic Authentication. We base64 encode the string ~alice:123~ and add it as a header to our HTTP requests:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice/inbox
Accept: text/turtle
Authorization: Basic YWxpY2U6MTIz
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/users/alice/inbox>
    a ldp:BasicContainer, as:Collection .

// GET http://localhost:4000/users/alice/inbox
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 396
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 07:32:01 GMT
// server: Cowboy
// x-request-id: FhBdiyinzlZ-fa8AAAFC
// Request duration: 0.991660s
#+END_SRC

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice/outbox
Accept: text/turtle
Authorization: Basic YWxpY2U6MTIz
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/users/alice/outbox>
    a ldp:BasicContainer, as:Collection .

// GET http://localhost:4000/users/alice/outbox
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 397
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 07:32:07 GMT
// server: Cowboy
// x-request-id: FhBdjMBAF8UPDiIAAAGi
// Request duration: 0.740926s
#+END_SRC


Both inbox and outbox are still empty.

Note that the inbox and outbox are both a Linked Data Platform basic containers and ActivityStreams collection.

* Posting an Activity

We create another user ~bob~:

#+BEGIN_SRC elixir
CPub.User.create(%{username: "bob", password: "123"})
#+END_SRC

We can get Bob's profile

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/bob
Accept: text/turtle
Authorization: Basic Ym9iOjEyMw==
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@base <http://localhost:4000/users/bob/> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/users/bob>
    a foaf:PersonalProfileDocument, as:Person ;
    ldp:inbox <inbox> ;
    foaf:primaryTopic <me> ;
    as:outbox <outbox> ;
    as:preferredUsername "bob" .

<me>
    a foaf:Person ;
    foaf:name "bob" ;
    foaf:nick "bob" .

// GET http://localhost:4000/users/bob
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 618
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 07:32:21 GMT
// server: Cowboy
// x-request-id: FhBdkAiCcyX5d1oAAAHi
// Request duration: 0.384137s
#+END_SRC

Now Alice can post a note to Bob:

#+BEGIN_SRC restclient :exports both
POST http://localhost:4000/users/alice/outbox
Authorization: Basic YWxpY2U6MTIz
Accept: text/turtle
Content-type: text/turtle

@prefix as: <https://www.w3.org/ns/activitystreams#> .

<>
    a as:Create ;
    as:to <http://localhost:4000/users/bob> ;
    as:object _:object .

_:object
    a as:Note ;
    as:content "Good day!"@en ;
    as:content "Guten Tag!"@de ;
    as:content "Gr端ezi"@gsw ;
    as:content "Bun di!"@roh .
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
// POST http://localhost:4000/users/alice/outbox
// HTTP/1.1 201 Created
// Location: http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1
// cache-control: max-age=0, private, must-revalidate
// content-length: 0
// date: Tue, 19 May 2020 07:36:11 GMT
// server: Cowboy
// x-request-id: FhBdxYLkMIB-fa8AAAAD
// Request duration: 1.087285s
#+END_SRC

The activity has been created and can be accessed:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1>
    a as:Create ;
    as:actor <http://localhost:4000/users/alice> ;
    as:object <http://localhost:4000/objects/db3a6f31-d0ca-4503-9965-15d305029970> ;
    as:published "2020-05-19T07:36:12"^^xsd:dateTime ;
    as:to <http://localhost:4000/users/bob> .

<http://localhost:4000/objects/db3a6f31-d0ca-4503-9965-15d305029970>
    a as:Note ;
    as:content "Guten Tag!"@de, "Good day!"@en, "Gr端ezi"@gsw, "Bun di!"@roh .

// GET http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 804
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 07:36:36 GMT
// server: Cowboy
// x-request-id: FhBdy4jVCnQPDiIAAAGB
// Request duration: 0.025441s
#+END_SRC

Note that no authentication is required to access the activity. Simply the fact of knowing the id (which is not guessable) is enough to gain access.

The object has been included in the response, but has an id of it's own and can be accessed directly:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/objects/db3a6f31-d0ca-4503-9965-15d305029970
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/objects/db3a6f31-d0ca-4503-9965-15d305029970>
    a as:Note ;
    as:content "Guten Tag!"@de, "Good day!"@en, "Gr端ezi"@gsw, "Bun di!"@roh .

// GET http://localhost:4000/objects/db3a6f31-d0ca-4503-9965-15d305029970
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 476
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 07:36:59 GMT
// server: Cowboy
// x-request-id: FhBd0OnNr2RtJ3cAAABD
// Request duration: 0.008618s
#+END_SRC

The activity has also been placed in the Alice's outbox:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice/outbox
Authorization: Basic YWxpY2U6MTIz
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1>
    a as:Create ;
    as:actor <http://localhost:4000/users/alice> ;
    as:object <http://localhost:4000/objects/db3a6f31-d0ca-4503-9965-15d305029970> ;
    as:published "2020-05-19T07:36:12"^^xsd:dateTime ;
    as:to <http://localhost:4000/users/bob> .

<http://localhost:4000/objects/db3a6f31-d0ca-4503-9965-15d305029970>
    a as:Note ;
    as:content "Guten Tag!"@de, "Good day!"@en, "Gr端ezi"@gsw, "Bun di!"@roh .

<http://localhost:4000/users/alice/outbox>
    a ldp:BasicContainer, as:Collection ;
    ldp:member <http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1> ;
    as:items <http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1> .

// GET http://localhost:4000/users/alice/outbox
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 1066
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 07:37:06 GMT
// server: Cowboy
// x-request-id: FhBd0iAcfjk0L-cAAAFE
// Request duration: 0.742755s
#+END_SRC

And in Bob's inbox:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/bob/inbox
Authorization: Basic Ym9iOjEyMw==
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1>
    a as:Create ;
    as:actor <http://localhost:4000/users/alice> ;
    as:object <http://localhost:4000/objects/db3a6f31-d0ca-4503-9965-15d305029970> ;
    as:published "2020-05-19T07:36:12"^^xsd:dateTime ;
    as:to <http://localhost:4000/users/bob> .

<http://localhost:4000/objects/db3a6f31-d0ca-4503-9965-15d305029970>
    a as:Note ;
    as:content "Guten Tag!"@de, "Good day!"@en, "Gr端ezi"@gsw, "Bun di!"@roh .

<http://localhost:4000/users/bob/inbox>
    a ldp:BasicContainer, as:Collection ;
    ldp:member <http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1> ;
    as:items <http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1> .

// GET http://localhost:4000/users/bob/inbox
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 1063
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 07:37:13 GMT
// server: Cowboy
// x-request-id: FhBd05n-CQDo--QAAACD
// Request duration: 0.727135s
#+END_SRC

* Public addressing

Alice can create a note that should be publicly accessible by addressing it to the special public collection (~https://www.w3.org/ns/activitystreams#Public~).

#+BEGIN_SRC restclient :exports both
POST http://localhost:4000/users/alice/outbox
Authorization: Basic YWxpY2U6MTIz
Accept: text/turtle
Content-type: text/turtle

@prefix as: <https://www.w3.org/ns/activitystreams#> .

<>
    a as:Create ;
    as:to as:Public ;
    as:object _:object .

_:object
    a as:Note ;
    as:content "Hi! This is a public note." .
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
// POST http://localhost:4000/users/alice/outbox
// HTTP/1.1 201 Created
// Location: http://localhost:4000/activities/90717db8-05b1-4af8-921b-f42fa0f658c9
// cache-control: max-age=0, private, must-revalidate
// content-length: 0
// date: Tue, 19 May 2020 07:38:07 GMT
// server: Cowboy
// x-request-id: FhBd4I1Fg-EWacoAAAHh
// Request duration: 0.754869s
#+END_SRC

This activity has been placed in Alice's outbox:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice/outbox
Authorization: Basic YWxpY2U6MTIz
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1>
    a as:Create ;
    as:actor <http://localhost:4000/users/alice> ;
    as:object <http://localhost:4000/objects/db3a6f31-d0ca-4503-9965-15d305029970> ;
    as:published "2020-05-19T07:36:12"^^xsd:dateTime ;
    as:to <http://localhost:4000/users/bob> .

<http://localhost:4000/activities/90717db8-05b1-4af8-921b-f42fa0f658c9>
    a as:Create ;
    as:actor <http://localhost:4000/users/alice> ;
    as:object <http://localhost:4000/objects/d10dbff9-f487-405e-9619-5a09abf9c3ec> ;
    as:published "2020-05-19T07:38:08"^^xsd:dateTime ;
    as:to as:Public .

<http://localhost:4000/objects/d10dbff9-f487-405e-9619-5a09abf9c3ec>
    a as:Note ;
    as:content "Hi! This is a public note." .

<http://localhost:4000/objects/db3a6f31-d0ca-4503-9965-15d305029970>
    a as:Note ;
    as:content "Guten Tag!"@de, "Good day!"@en, "Gr端ezi"@gsw, "Bun di!"@roh .

<http://localhost:4000/users/alice/outbox>
    a ldp:BasicContainer, as:Collection ;
    ldp:member <http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1>, <http://localhost:4000/activities/90717db8-05b1-4af8-921b-f42fa0f658c9> ;
    as:items <http://localhost:4000/activities/6e6e7837-789a-4ca3-ad3c-c1391828a7b1>, <http://localhost:4000/activities/90717db8-05b1-4af8-921b-f42fa0f658c9> .

// GET http://localhost:4000/users/alice/outbox
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 1648
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 07:38:14 GMT
// server: Cowboy
// x-request-id: FhBd4kqmuKIGm5UAAAIB
// Request duration: 0.741971s
#+END_SRC

It can also be accessed from the special endpoint for public activities:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/public
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/activities/90717db8-05b1-4af8-921b-f42fa0f658c9>
    a as:Create ;
    as:actor <http://localhost:4000/users/alice> ;
    as:object <http://localhost:4000/objects/d10dbff9-f487-405e-9619-5a09abf9c3ec> ;
    as:published "2020-05-19T07:38:08"^^xsd:dateTime ;
    as:to as:Public .

<http://localhost:4000/objects/d10dbff9-f487-405e-9619-5a09abf9c3ec>
    a as:Note ;
    as:content "Hi! This is a public note." .

<http://localhost:4000/public>
    a ldp:BasicContainer, as:Collection ;
    ldp:member <http://localhost:4000/activities/90717db8-05b1-4af8-921b-f42fa0f658c9> ;
    as:items <http://localhost:4000/activities/90717db8-05b1-4af8-921b-f42fa0f658c9> .

// GET http://localhost:4000/public
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 997
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 07:38:26 GMT
// server: Cowboy
// x-request-id: FhBd5SDXcN7XuEkAAAJB
// Request duration: 0.012005s
#+END_SRC

* Authentication

* Generality

CPub has an understanding of what activities are (as defined in ActivityStreams) and uses this understanding to figure out what to do when you post something to an outbox.

Other than that, CPub is completely oblivious to what kind of data you create, share or link to (as long as it is RDF).
** Event

For example we can create an event instead of a note (using the schema.org vocabulary):

#+BEGIN_SRC restclient :exports both
POST http://localhost:4000/users/alice/outbox
Authorization: Basic YWxpY2U6MTIz
Accept: text/turtle
Content-type: text/turtle

@prefix as: <https://www.w3.org/ns/activitystreams#> .
@prefix schema: <http://schema.org/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema> .

<>
    a as:Create ;
    as:to <http://localhost:4000/users/bob> ;
    as:object _:object .

_:object
    a schema:Event ;
    schema:name "My super cool event" ;
    schema:url "http://website-to-my-event" ;
    schema:startDate "2020-04-31T00:00:00+01:00"^^xsd:date ;
    schema:endDate "2020-05-02T00:00:00+01:00"^^xsd:date .

#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
// POST http://localhost:4000/users/alice/outbox
// HTTP/1.1 201 Created
// Location: http://localhost:4000/activities/25b66e40-9013-4a5e-9d68-4e663917e60a
// access-control-allow-credentials: true
// access-control-allow-origin: *
// access-control-expose-headers:
// cache-control: max-age=0, private, must-revalidate
// content-length: 0
// date: Mon, 23 Mar 2020 08:18:15 GMT
// server: Cowboy
// x-request-id: Ff7g_K7WP58ktZQAAACi
// Request duration: 0.460113s
#+END_SRC

The activity:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/activities/25b66e40-9013-4a5e-9d68-4e663917e60a
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/activities/25b66e40-9013-4a5e-9d68-4e663917e60a>
    a as:Create ;
    as:actor <http://localhost:4000/users/alice> ;
    as:object <http://localhost:4000/objects/b9e52df0-c5ec-4bd6-ae0c-1d06229e8235> ;
    as:published "2020-03-23T08:18:15"^^xsd:dateTime ;
    as:to <http://localhost:4000/users/bob> .

<http://localhost:4000/objects/b9e52df0-c5ec-4bd6-ae0c-1d06229e8235>
    a <http://schema.org/Event> ;
    <http://schema.org/endDate> "2020-05-02T00:00:00+01:00"^^<http://www.w3.org/2001/XMLSchemadate> ;
    <http://schema.org/name> "My super cool event" ;
    <http://schema.org/startDate> "2020-04-31T00:00:00+01:00"^^<http://www.w3.org/2001/XMLSchemadate> ;
    <http://schema.org/url> "http://website-to-my-event" .

// GET http://localhost:4000/activities/25b66e40-9013-4a5e-9d68-4e663917e60a
// HTTP/1.1 200 OK
// access-control-allow-credentials: true
// access-control-allow-origin: *
// access-control-expose-headers:
// cache-control: max-age=0, private, must-revalidate
// content-length: 1016
// content-type: text/turtle; charset=utf-8
// date: Mon, 23 Mar 2020 08:18:36 GMT
// server: Cowboy
// x-request-id: Ff7hAd1wO0YX_SwAAAPB
// Request duration: 0.033932s
#+END_SRC

The event can be commented on, liked or shared, like any other ActivityPub object.

** Geo data

It is also possible to post geospatial data. For example a geo-tagged note:

#+BEGIN_SRC restclient :exports both
POST http://localhost:4000/users/alice/outbox
Authorization: Basic YWxpY2U6MTIz
Accept: text/turtle
Content-type: text/turtle

@prefix as: <https://www.w3.org/ns/activitystreams#> .
@prefix geo: <http://www.w3.org/2003/01/geo/wgs84_pos#> .

<>
    a as:Create ;
    as:to <http://localhost:4000/users/bob> ;
    as:object _:object .

_:object
    a as:Note ;
    as:content "The water here is amazing!"@en ;
    geo:lat 46.794932821448725 ;
    geo:long 10.300304889678957 .

#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
// POST http://localhost:4000/users/alice/outbox
// HTTP/1.1 201 Created
// Location: http://localhost:4000/activities/34d9dbff-ed6a-40e6-a3ee-5ff684ebcce5
// access-control-allow-credentials: true
// access-control-allow-origin: *
// access-control-expose-headers:
// cache-control: max-age=0, private, must-revalidate
// content-length: 0
// date: Mon, 23 Mar 2020 08:19:15 GMT
// server: Cowboy
// x-request-id: Ff7hCqvAxXKAbwAAAAPh
// Request duration: 0.465579s
#+END_SRC

A geo-tagged note has been created:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/activities/34d9dbff-ed6a-40e6-a3ee-5ff684ebcce5
Accept: text/turtle
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/activities/34d9dbff-ed6a-40e6-a3ee-5ff684ebcce5>
    a as:Create ;
    as:actor <http://localhost:4000/users/alice> ;
    as:object <http://localhost:4000/objects/4a639d11-6d89-42c1-9610-e6133f5137ed> ;
    as:published "2020-03-23T08:19:15"^^xsd:dateTime ;
    as:to <http://localhost:4000/users/bob> .

<http://localhost:4000/objects/4a639d11-6d89-42c1-9610-e6133f5137ed>
    a as:Note ;
    <http://www.w3.org/2003/01/geo/wgs84_pos#lat> 46.794932821448725 ;
    <http://www.w3.org/2003/01/geo/wgs84_pos#long> 10.300304889678957 ;
    as:content "The water here is amazing!"@en .

// GET http://localhost:4000/activities/34d9dbff-ed6a-40e6-a3ee-5ff684ebcce5
// HTTP/1.1 200 OK
// access-control-allow-credentials: true
// access-control-allow-origin: *
// access-control-expose-headers:
// cache-control: max-age=0, private, must-revalidate
// content-length: 872
// content-type: text/turtle; charset=utf-8
// date: Mon, 23 Mar 2020 08:19:37 GMT
// server: Cowboy
// x-request-id: Ff7hD_9GGygHB2UAAAQB
// Request duration: 0.051139s
#+END_SRC

A client that understands what ~geo:lat~ and ~geo:long~ means could show this note on a map. 

See [[https://gitlab.com/miaEngiadina/geopub][GeoPub]] for a client that understands ~geo:lat~ and ~geo:long~.

* Authorization
** Local

For local authorization an app is automatically created:

#+BEGIN_SRC elixir
CPub.Web.OAuth.App.get_or_create_local_app
#+END_SRC
#+RESULTS:
#+BEGIN_SRC elixir
{:ok,
 %CPub.Web.OAuth.App{
   __meta__: #Ecto.Schema.Metadata<:loaded, "oauth_apps">,
   authorizations: #Ecto.Association.NotLoaded<association :authorizations is not loaded>,
   client_id: "lF2t04BPGY6X7cleouE5BBXKwbSSYYqp",
   client_name: "local",
   client_secret: "v26Owtqorzqy81CkxTLm_aBcifLaf4UZ",
   id: 3,
   inserted_at: ~N[2020-05-19 08:43:10],
   provider: "local",
   redirect_uris: ". urn:ietf:wg:oauth:2.0:oob",
   scopes: ["read"],
   tokens: #Ecto.Association.NotLoaded<association :tokens is not loaded>,
   trusted: true,
   updated_at: ~N[2020-05-19 08:43:10],
   website: nil
 }}
#+END_SRC

The ~client_id~ and ~client_secret~ can be used to create an authorization code. Note that we use the special ~urn:ietf:wg:oauth:2.0:oob~ redirect_uri which just returns the access token "out of band" instead of redirecting.

#+BEGIN_SRC restclient :exports both
POST http://localhost:4000/auth/authorize
Accept: application/json
Content-type: application/json

{"authorization":
    {
    "client_id": "lF2t04BPGY6X7cleouE5BBXKwbSSYYqp",
    "client_secret": "v26Owtqorzqy81CkxTLm_aBcifLaf4UZ",
    "redirect_uri": "urn:ietf:wg:oauth:2.0:oob",
    "username": "alice",
    "password": "123",
    "scopes": ["read"]
    }
 }
#+END_SRC

#+RESULTS:
#+BEGIN_SRC text
Authorization code: O1FutNCuP_YfBUnhoPuxqhx47y4Zggm9
POST http://localhost:4000/auth/authorize
HTTP/1.1 200 OK
cache-control: max-age=0, private, must-revalidate
content-length: 52
content-type: text/plain; charset=utf-8
date: Tue, 19 May 2020 08:58:31 GMT
server: Cowboy
x-request-id: FhBiQ6dbGn75d1oAAAUB
Request duration: 0.398076s
#+END_SRC

The authorization code can be exchanged for a token (note that authorization code is only valid for 10 minutes):

#+BEGIN_SRC restclient :exports both
POST http://localhost:4000/auth/token
Accept: application/json
Content-type: application/json

{"grant_type": "authorization_code",
 "client_id": "lF2t04BPGY6X7cleouE5BBXKwbSSYYqp",
 "client_secret": "v26Owtqorzqy81CkxTLm_aBcifLaf4UZ",
 "code": "O1FutNCuP_YfBUnhoPuxqhx47y4Zggm9"
 }
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
{
  "access_token": "HMs2NSsDwXip2M6Av9n3B29mPsgi0NQR",
  "created_at": 1589878749,
  "expires_in": 3600,
  "refresh_token": "uxtPizLeCyrcklEYwjrIcAdEKPdc9ffO",
  "scope": "read",
  "token_type": "Bearer"
}
// POST http://localhost:4000/auth/token
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 181
// content-type: application/json; charset=utf-8
// date: Tue, 19 May 2020 08:59:09 GMT
// server: Cowboy
// x-request-id: FhBiTJN6aHA0L-cAAABj
// Request duration: 0.040286s
#+END_SRC

The returned ~access_token~ can be used for authenticated API calls:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice/inbox
Accept: text/turtle
Authorization: Bearer HMs2NSsDwXip2M6Av9n3B29mPsgi0NQR
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/users/alice/inbox>
    a ldp:BasicContainer, as:Collection .

// GET http://localhost:4000/users/alice/inbox
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 396
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 09:00:52 GMT
// server: Cowboy
// x-request-id: FhBiZIhwBgUPbroAAAVB
// Request duration: 0.202621s
#+END_SRC

The token is valid for one hour. The token can be refreshed using the ~refresh_token~:

#+BEGIN_SRC restclient :exports both
POST http://localhost:4000/auth/token
Accept: application/json
Content-type: application/json

{"grant_type": "refresh_token",
 "refresh_token": "uxtPizLeCyrcklEYwjrIcAdEKPdc9ffO",
 "client_id": "lF2t04BPGY6X7cleouE5BBXKwbSSYYqp",
 "client_secret": "v26Owtqorzqy81CkxTLm_aBcifLaf4UZ"
 }
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
{
  "access_token": "cZ_CfkQjwS4XnTcEepcPkimhWNEoVArh",
  "created_at": 1589879175,
  "expires_in": 3600,
  "refresh_token": "uxtPizLeCyrcklEYwjrIcAdEKPdc9ffO",
  "scope": "read",
  "token_type": "Bearer"
}
// POST http://localhost:4000/auth/token
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 181
// content-type: application/json; charset=utf-8
// date: Tue, 19 May 2020 09:06:15 GMT
// server: Cowboy
// x-request-id: FhBir8ogGdl0bekAAASh
// Request duration: 0.065933s
#+END_SRC


The initial access token has been revoked and can no longer be used:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice/inbox
Accept: text/turtle
Authorization: Bearer HMs2NSsDwXip2M6Av9n3B29mPsgi0NQR
#+END_SRC

#+RESULTS:
#+BEGIN_SRC text
401 Unauthorized
GET http://localhost:4000/users/alice/inbox
HTTP/1.1 401 Unauthorized
cache-control: max-age=0, private, must-revalidate
content-length: 16
content-type: text/plain; charset=utf-8
date: Tue, 19 May 2020 09:06:32 GMT
server: Cowboy
x-request-id: FhBis-_mgtQssLUAAATB
Request duration: 0.020969s
#+END_SRC

Use the new access token:

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice/inbox
Accept: text/turtle
Authorization: Bearer cZ_CfkQjwS4XnTcEepcPkimhWNEoVArh
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ldp: <http://www.w3.org/ns/ldp#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix as: <https://www.w3.org/ns/activitystreams#> .

<http://localhost:4000/users/alice/inbox>
    a ldp:BasicContainer, as:Collection .

// GET http://localhost:4000/users/alice/inbox
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 396
// content-type: text/turtle; charset=utf-8
// date: Tue, 19 May 2020 09:07:25 GMT
// server: Cowboy
// x-request-id: FhBiwAt9m3ctnpMAAACC
// Request duration: 0.193498s
#+END_SRC

* Serialization Formats

In the examples above we have used the RDF/Turtle serialization.

CPub supports following RDF serialization formats:

- [[https://www.w3.org/TR/turtle/][RDF 1.1 Turtle]]
- [[https://www.w3.org/TR/rdf-json/][RDF 1.1 JSON Alternate Serialization (RDF/JSON)]]

** RDF/JSON

To get content as RDF/JSON set the ~Accept~ header to ~application/rdf+json~

#+BEGIN_SRC restclient :exports both
GET http://localhost:4000/users/alice
Accept: application/rdf+json
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
{
  "http://localhost:4000/users/alice": {
    "http://www.w3.org/1999/02/22-rdf-syntax-ns#type": [
      {
        "type": "uri",
        "value": "https://www.w3.org/ns/activitystreams#Person"
      }
    ],
    "http://www.w3.org/ns/ldp#inbox": [
      {
        "type": "uri",
        "value": "http://localhost:4000/users/alice/inbox"
      }
    ],
    "https://www.w3.org/ns/activitystreams#outbox": [
      {
        "type": "uri",
        "value": "http://localhost:4000/users/alice/outbox"
      }
    ],
    "https://www.w3.org/ns/activitystreams#preferredUsername": [
      {
        "type": "literal",
        "value": "alice"
      }
    ]
  }
}
// GET http://localhost:4000/users/alice
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 471
// content-type: application/rdf+json; charset=utf-8
// date: Tue, 12 May 2020 14:06:41 GMT
// server: Cowboy
// x-request-id: Fg5NBPD2PLIUstgAADPj
// Request duration: 0.194322s
#+END_SRC

Data can also be posted as RDF/JSON by setting ~Content-type~ header:

#+BEGIN_SRC restclient :exports both
POST http://localhost:4000/users/alice/outbox
Authorization: Basic YWxpY2U6MTIz
Content-type: application/rdf+json

{
  "_:object": {
    "http://www.w3.org/1999/02/22-rdf-syntax-ns#type": [
      {
        "type": "uri",
        "value": "https://www.w3.org/ns/activitystreams#Note"
      }
    ],
    "https://www.w3.org/ns/activitystreams#content": [
      {
        "lang": "en",
        "type": "literal",
        "value": "Hi! This is RDF/JSON. It's ugly, but it's simple."
      }
    ]
  },
  "http://example.org": {
    "http://www.w3.org/1999/02/22-rdf-syntax-ns#type": [
      {
        "type": "uri",
        "value": "https://www.w3.org/ns/activitystreams#Create"
      }
    ],
    "https://www.w3.org/ns/activitystreams#object": [
      {
        "type": "bnode",
        "value": "_:object"
      }
    ],
    "https://www.w3.org/ns/activitystreams#to": [
      {
        "type": "uri",
        "value": "http://localhost:4000/users/bob"
      }
    ]
  }
}
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
// POST http://localhost:4000/users/alice/outbox
// HTTP/1.1 201 Created
// Location: http://localhost:4000/activities/4505866b-9ab7-4797-b6d7-5169b3117ffa
// cache-control: max-age=0, private, must-revalidate
// content-length: 0
// date: Tue, 12 May 2020 14:34:38 GMT
// server: Cowboy
// x-request-id: Fg5Oi07r6BalK50AAAEC
// Request duration: 0.474051s
#+END_SRC
